#!/bin/bash
#
# Script:       common.sh
#
# Usage:        
#
# Author:       Grenville Whelan, Access Identified Limited
#
# Description:  
#
# See Also:     create_tf.sh  destroy_tf.sh
#
#

# Global variables

TLD="/Users/grenvillewhelan/AccessIdentified/BT"
PACKER_DIR=${TLD}/packer
TEMPLATE_DIR=${TLD}/template.tf
DEFAULT_STATE_LOCKFILE="lock"
AMI_PREFIX="AIL"
AWS_CRED=${HOME}"/.aws/credentials"
AWS_ARGS="--region ${AWS_REGION} --profile ${AWS_PROFILE}"
RESOURCE_GROUP_NAME="tfstate"
DEFAULT_STATE_STORAGE="tfremotestate.aws.accessidentified.com"
STORAGE_ACCOUNT_NAME="tfstatedevgwhelan"

TF_AWS_VERSION="5.88.0"
TF_AZURE_VERSION="4.20.0"

OS_BASE_AZURE="Ubuntu-22_04-lts"
OS_BASE_AZURE_WINDOWS="Windows_Server-2022-English-Core-Base"
OS_BASE_AWS="ubuntu-jammy-22.04-arm64-server"
OS_BASE_AWS_WINDOWS="Windows_Server-2022-English-Core-Base"
OS_BASE_AWS_REDHAT="RHEL-9.*-arm64"

ARM_ACCOUNT_KEY="no-azure-not-applicable"
ARM_CLIENT_ID="no-azure-not-applicable"
ARM_CLIENT_SECRET="no-azure-not-applicable"
ARM_SUBSCRIPTION_ID="a892d455-55f8-4480-9e0f-594266d96b54"
ARM_TENANT_ID="32e7422c-0a0d-48fd-b631-e2f22d217eff"


#TAG_VERSION=$(cd ${TLD}; git describe --tags 2> /dev/null | awk -F- '{print $1}')
TAG_VERSION="v1.0.0e"

if [ -z "${TAG_VERSION}" ]; then
   TAG_VERSION="test-no-tag"
fi

platform_package_checks="is_package_installed ${cloud_providers}"
number_regions=$(jq -n "${TFVARS_JSON}" | \
                        jq -r '.manifest["'${CLOUD_PLATFORM}'"] | keys' 2> /dev/null | \
                        wc -l | awk '{print $1-2}')

tf_state_cloud_provider=$(echo ${cloud_providers} | awk '{print $1}')

##
## Routines
##

# Ask a Yes or No question
# argument given is the question, if "n" is answered we exit with $2 otherwise return

function exit_on_no() {
   response=""

   while [ "${response}" != "y" ]
   do
      nrblue_echo "$1 [y/n] : "
      read response
   
      if [ "${response}" == "n" ]; then
         echo "Ok, exiting."
         echo
         exit_prog $2
      fi
   done
}

function quiet_read() {
   stty -echo
   read response
   stty echo
   echo ${response}
}

function display_logo() {
   BLUE="\033[0m\033[34m\033[1m"
   COLOUR_OFF="\033[0m"


   echo
   printf "${BLUE}                                    _____    _            _   _  __ _          _  ${COLOUR_OFF}\n"
   printf "${BLUE}         /\                        |_   _|  | |          | | (_)/ _(_)        | | ${COLOUR_OFF}\n"
   printf "${BLUE}        /  \   ___ ___ ___  ___ ___  | |  __| | ___ _ __ | |_ _| |_ _  ___  __| | ${COLOUR_OFF}\n"
   printf "${BLUE}       / /\ \ / __/ __/ _ \/ __/ __| | | / _\` |/ _ \ '_ \| __| |  _| |/ _ \/ _\` | ${COLOUR_OFF}\n"
   printf "${BLUE}      / ____ \ (_| (_|  __/\__ \__ \_| || (_| |  __/ | | | |_| | | | |  __/ (_| | ${COLOUR_OFF}\n"
   printf "${BLUE}     /_/    \_\___\___\___||___/___/_____\__,_|\___|_| |_|\__|_|_| |_|\___|\__,_| ${COLOUR_OFF}\n"
   echo

}

function return1_on_no() {
   response=""

   while [ "${response}" != "y" ]
   do
      nrblue_echo "$* [y/n/q] : "
      read response

      if [ "${response}" == "q" ]; then
         exit 1
      fi
   
      if [ "${response}" == "n" ]; then
         return 1
      fi
   done

   return 0
}


function create_tfvars() {

   echo "//"
   echo "// Customer-specific parameters, auto-generated by automation"
   echo "//"
   echo 
   echo "customer_name             = \""${customer_name}"\""

   if [ "${tf_state_cloud_provider}" == "aws" ]; then
      echo "cloud_provider            = \"aws\""
      echo "cloud_region              = \"${primary_aws_region}\""
   fi

   if [ "${tf_state_cloud_provider}" == "azure" ]; then
      echo "cloud_provider            = \"azure\""
      echo "cloud_region              = \"${primary_azure_region}\""
   fi

   echo "tf_state_cloud_provider   = \"${tf_state_cloud_provider}\""
   echo "cloud_providers           = \"$(echo ${cloud_providers})\""
   echo "terraform_backend_storage = \""${state_storage}"\""
   echo "terraform_state_locking   = \""${lockfile}"\""
   echo "remote_state              = \""${remote_state}"\""
   echo "deployment_status         = \"${deployment_status}\"" 


   echo
   echo "//"
   echo
}


# If ${DEBUG} is set (to a file name), append out to it, otherwise just write
# to stdout

function logorno() {
   if [ "${DEBUG}" == "" ]; then
      eval $*
      return $?
   else
     eval $* >> ${DEBUG}
     return $?
   fi
}

function writelog() {

   if [ "${DEBUG}" != "" ]; then
      time_now=$(date +"%d-%m-%y %H:%M:%S")
      bold_echo "${time_now} - ${*}" >> ${DEBUG}
   fi
}

function bold_echo() {
   echo -e "\033[0m\033[1m$* \033[0m"
}

function nrblue_echo() {
   echo -en "\033[0m\033[34m\033[1m$* \033[0m"
}

function red_echo() {
   echo -e "\033[0m\033[31m\033[1m$* \033[0m"
}

function yellow_echo() {
   echo -e "\033[0m\033[33m\033[1m$* \033[0m"
}

function exit_prog() {

   if [ $1 -eq 1 ]; then
      echo
      red_echo "$0: Warning, premature exit, please manually clean up the following operations:"
      echo
      echo "   Customer          : "${customer_name}
      echo "   Region            : "${primary_region}
      echo "   DynamoDB Table    : "${lockfile}
      echo "   State Storage     : "${bucket}
      echo
   fi

   exit $1
}

function chk_file() {

   echo $1 | \
      awk '{ printf("Checking for file ")
             if (length($1) > 46)
                printf("**%s .. ", substr($1,length($1)-43,44))
             else
                printf("%-46s .. ",$1)
           }'

   if [ ! -f $1 ]; then
      red_echo "cannot locate file, exiting."
      return 1
   fi

   echo "available."
}

function chk_dir() {

   echo $1 | \
      awk '{ printf("Checking for directory ")
             if (length($1) > 41)
                printf("**%s .. ", substr($1,length($1)-38,40))
             else
                printf("%-41s .. ",$1)
           }'

   if [ ! -d $1 ]; then
      red_echo "cannot locate directory, exiting."
      return 1
   fi

   echo "available."
}

function is_package_installed() {

   package=$1

   if [ "${package}" == "azure" ]; then
      package=az
   fi

   printf "Checking for %-51s .. " ${package}
   packge_version=$(${package} --version 2>/dev/null)

   if [ $? -ne 0 ]; then
      red_echo "cannot locate: install or check PATH first, exiting."
      return 1
   else
      echo -n "packge_version: "
      ${package} --version | \
         head -1 | \
         awk '{if (length($0) < 34) print $0; else printf("%s**\n", substr($0,0,30))}'

      return 0
   fi
}

function is_git_image_downloaded() {
   printf "Checking for git download of %-34s  .. " $1

   if [ -d ./$1 ]; then
      pwd
      return 0
   else
      red_echo "no, run gh repo clone git@github.com:accessidentified.com/$1.git"
      return 1
   fi
}

function write_tf_header() {

   echo "// "
   echo "// $1 - generated by ${THIS_PROG} version ${TAG_VERSION} at $(date)"
   echo "//"
   echo
}

function get_deployment_parameter() {

   jq -n "${TFVARS_JSON}" | \
   jq -r '.'${1}''
}

function check_product_dependencies() {

   region_number=$1
   errors=0

   for product in $(jq -n "${TFVARS_JSON}" | \
                    jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products | keys | .[] ')
   do
      product_installed=$(jq -n "${TFVARS_JSON}" | \
                          jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]')

      if [ "${product_installed}" == "null" ]; then
         product_intalled=0
      fi

      if [ ${product_installed} -gt 0 ]; then
      
         for require in $(jq -n "${TFVARS_JSON}" | \
              jq -r '.products["'${product}'"].requires')
         do
            requirement_installed=$(jq -n "${TFVARS_JSON}" | \
               jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${require}'"]["'${environment_name}'"]')

            if [ "${requirement_installed}" == "null" ]; then
               requirement_installed=0
            fi

            if [ ${requirement_installed} -eq 0 ]; then
               echo -n "   product \"${product}\" requires \"${require}\" .. "
               red_echo " not configured in deployment"
               ((errors+=1))
            fi
         done
      fi
   done

   return ${errors}
}

function get_regions() {

   cloud_provider=$1
   type=$2
   region_list=""
   primary_region=""

   number_cloud_regions=$(jq -n "${TFVARS_JSON}" | \
                          jq -r '.manifest["'${cloud_provider}'"] | length' 2> /dev/null)
   region_number=0

   while [ ${region_number} -lt ${number_cloud_regions} ]; do
      new_region=$(jq -n "${TFVARS_JSON}" | \
                   jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_name' 2> /dev/null)
      region_list="${region_list} ${new_region}"

      if [ -z "${primary_region}" ]; then
         primary_region=$(echo ${region_list})
      fi

      ((region_number+=1))
   done

   if [ "${type}" == "primary" ]; then
      echo ${primary_region}
   else
      if [ "${type}" == "secondary" ]; then
         echo ${region_list} | sed 's/'${primary_region}'//'
      else
         echo ${region_list}
      fi
   fi
}

function get_region_alias() {

   region_name=$1
   region_alias=""

  for cloud_provider in ${cloud_providers}
   do
      number_cloud_regions=$(jq -n "${TFVARS_JSON}" | \
                             jq -r '.manifest["'${cloud_provider}'"] | keys' | \
                             wc -l | awk '{print $1-2}')
      region_number=0

      while [ ${region_number} -lt ${number_cloud_regions} ]; do
         if [ "$(jq -n "${TFVARS_JSON}" | \
                 jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_name')" == "${region_name}" ]; then
            region_alias=$(jq -n "${TFVARS_JSON}" | \
                           jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_alias')
         fi

         ((region_number+=1))
      done
   done
   echo ${region_alias}
}

function get_product_regions() {

   product=$1
   region_list=""

   for cloud_provider in ${cloud_providers}
   do
      number_cloud_regions=$(jq -n "${TFVARS_JSON}" | \
                             jq -r '.manifest["'${cloud_provider}'"] | keys' | \
                             wc -l | awk '{print $1-2}')
      region_number=0

      while [ ${region_number} -lt ${number_cloud_regions} ]; do

         product_installed=$(jq -n "${TFVARS_JSON}" | \
                             jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]')

         if [ ${product_installed} -gt 0 ]; then
            jq -n "${TFVARS_JSON}" | \
            jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_name'
         fi
   
         ((region_number+=1))

      done
   done | awk '{printf("%s,",$1)}END{printf("\n")}' | sed 's/,$//g'
}

function chk_ami() {

   cloud_provider=$1
   region_number=$2
   environment_name=$3
   ami_region=$4
   retVal=0    
   amis_located=0

   echo
   echo "Checking availability of required ${cloud_provider} AMIs at ${ami_region}:"
   echo
      
   installed_amis=$(get_installed_amis ${cloud_provider} | awk -F: '{print $2}')

   for product in $(jq -n "${TFVARS_JSON}" | \
                    jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products | keys | .[] ')
   do
      if [ $(jq -n "${TFVARS_JSON}" | \
             jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]') -gt 0 ]; then
         ami_version=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.products["'${product}'"].ami["'${cloud_provider}'"]["'${environment_name}'"]' 2>/dev/null)

         if [ -n "${ami_version}" -a "${ami_version}" != "null" ]; then
            identified_ami=""

            for ami_list in ${installed_amis}
            do
               if [ -n "$(echo ${ami_list} | grep ${ami_version})" ]; then
                  identified_ami=${ami_list}
               fi
            done

            if [ -z "${identified_ami}" ]; then
               yellow_echo " - cannot locate AMI \"${ami_version}\" at ${check_region}"
               retVal=1
            else
               yellow_echo " - identified \"${product}\" AMI ${identified_ami} at ${check_region}"
               ((amis_located+=1))
            fi
         fi
      fi
   done

   if [ ${retVal} -eq 0 -a ${amis_located} -ne 0 ]; then
      return 2
   else
      return ${retVal}
   fi
}

function get_subnet_index() {

   region_number=$1
   az=$2
   subnet=$3
    
   subnet_length=$(jq -n "${TFVARS_JSON}" | \
                   jq -r '.subnets | length')
   az_length=$(jq -n "${TFVARS_JSON}" | \
               jq -r '.manifest["'${CLOUD_PLATFORM}'"]['${region_number}'].azs | length')
   total_subnets=$(expr ${subnet_length} \* ${az_length})
    
   subnet_number=0
      
   while [ ${subnet_number} -lt ${total_subnets} ]; do
      subnet_index=$(expr ${subnet_number} % ${subnet_length})
      az_index=$(expr ${subnet_number} % ${az_length})

      if [ ${subnet_index} -eq ${subnet} -a ${az_index} -eq ${az} ]; then
         echo ${subnet_number}
      fi

    ((subnet_number+=1))
   done
}

function create_pem() {
   cat << EOF > ${TF_DIR}/create_pem.sh
#!/bin/bash
      
PEM_FILE="admin_access.pem"
   
if [ "\$1" == "true" ]; then
   if [ \! -f \${PEM_FILE} ]; then
      (echo "-----BEGIN RSA PRIVATE KEY-----";
       echo \${SECKEY} | sed 's/-----BEGIN RSA PRIVATE KEY----- //' | sed 's/ -----END RSA PRIVATE KEY-----//' | tr ' ' '\n'
       echo "-----END RSA PRIVATE KEY-----") > \${PEM_FILE}
      chmod 400 \${PEM_FILE}
   fi 
fi
EOF

   chmod +x ${TF_DIR}/create_pem.sh
}

function create_main() {

   subscription_id=$(get_account_owner "azure")

   if [ "${tf_state_cloud_provider}" != "aws" -a "${tf_state_cloud_provider}" != "azure" ]; then
      red_echo "Warning: unknown cloud provider \"${tf_state_cloud_provider}\" for tf_state_cloud_provider, exiting"
      return 1
   fi

   echo 'terraform {
   required_version = "~> 1.1"

   required_providers {
'

   if [ "$(cloud_provider_installed aws)" == "yes" ]; then
      echo '      aws = {
         source  = "hashicorp/aws"
         version = "~> '${TF_AWS_VERSION}'"
      }
'
   fi

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then
      echo '       azurerm = {
         source  = "hashicorp/azurerm"
         version = "~> '${TF_AZURE_VERSION}'"
      }'
   fi

   echo '   }
'

   if [ "${tf_state_cloud_provider}" == "aws" ]; then
      echo '   backend "s3" {
      bucket         = "!!STATE_STORAGE!!"
      key            = "!!CUSTOMER!!/state"
      region         = "!!PRIMARY_AWS_REGION!!"
      profile        = "!!REMOTE_STATE!!"
      encrypt        = true
      dynamodb_table = "!!LOCKFILE!!"
   }
'
   fi

   if [ "${tf_state_cloud_provider}" == "azure" ]; then
      echo '   backend "azurerm" {
      subscription_id           = "!!SUBSCRIPTION_ID!!"
      resource_group_name       = "!!RESOURCE_GROUP_NAME!!"
      storage_account_name      = "!!STORAGE_ACCOUNT_NAME!!"
      container_name            = "!!STATE_STORAGE!!"
      key                       = "terraform.tfstate"
  }'
   fi

   echo '}
'

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then
      echo 'provider "azurerm" {
   subscription_id        = "'${subscription_id}'"
   features {
      key_vault {
         purge_soft_delete_on_destroy    = false
         recover_soft_deleted_key_vaults = true
      }
   }
}

resource "azurerm_resource_group" "environment" {
  name     = "!!CUSTOMER!!-!!ENVIRONMENT!!-resource-group"
  location = "!!PRIMARY_AZURE_REGION!!"
}
'
   fi
}

function cloud_provider_installed() {
   check=$1

   for cloud_provider in ${cloud_providers}
   do
      if [ "${check}" == "${cloud_provider}" ]; then
         echo "yes"
         return
      fi
   done

   echo "no"
}

function get_credential() {

   cred=$1
   key=$2

   if [ ! -f ${AWS_CRED} ]; then
      red_echo "Warning: cannot open ${AWS_CRED}, exiting"
      exit 1
   fi

   cat ${AWS_CRED} | awk 'BEGIN{x=0}{ \

         if ($1=="["AWS_PROFILE"]")
            x=1

         if (x == 1) {
            if (substr($0,0,length(SEARCH_TERM)) == SEARCH_TERM) {
               printf("%s",$0);
               x=0
            }
         }

      }' AWS_PROFILE=${cred} SEARCH_TERM=${key} | awk -F= '{print $2}' | awk '{print $1}'
}

function list_credential() {

   if [ ! -f ${AWS_CRED} ]; then
      red_echo "Warning: cannot open ${AWS_CRED}, exiting"
      exit 1
   fi

   cat ${AWS_CRED} | awk 'BEGIN{x=0}{ \

         if ($1==CREDENTIAL)
            x=1
         else
            if (substr($1,0,1) == "[")
               x=0

         if (x)
           print $0

      }' CREDENTIAL=[$1]
}

function replace_credential() {

   CRED=$1
   CREDTMP=$1.tmp$$
   CREDBACK=${CRED}.bak$$

   if [ ! -w ${CRED} ]; then
      echo "Do not have permissions to update credentials file ${CRED}, exiting"
      return 1
   fi

   touch ${CREDTMP} 2> /dev/null

   if [ $? -ne 0 ]; then
      echo "Do not have permissions to write temporary file ${CREDTMP}, exiting"
      return 1
   fi

   if [ ! -f ${CRED} ]; then
      echo "Cannot open credentials file ${CRED}"
      return 1
   fi
   credential_header="["$2"]"

   cat $1 | awk 'BEGIN{

      marker=0; ch=0 }
      {
        if ($1 == CRED) {
           marker=1
           printf "%s\n", $0
        }
        else
           if (substr($1,0,1) == "[")
              marker=0

        if (marker == 1) {

           if (substr($1,0,17) == "aws_access_key_id") {
              ch=1
              printf("aws_access_key_id=%s\n",KEY)
           }

           if (substr($1,0,21) == "aws_secret_access_key") {
              ch=1
              printf("aws_secret_access_key=%s\n\n",SECRET)
           }
        }
        else
           printf "%s\n",$0
      }END{
         if (ch == 0)
            printf("\n%s\naws_access_key_id=%s\naws_secret_access_key=%s\n",CRED,KEY,SECRET)

      }' CRED=${credential_header} KEY=$3 SECRET=$4 > ${CREDTMP}

   cat ${CRED} > ${CREDBACK}
   mv -f ${CREDTMP} ${CRED}
   return $?
}

function check_credential_entry() {
   x=0
   CRED=$1

   if [ ! -f $CRED ]; then
      echo "Cannot open credentials file $CRED"
      return 1
   fi

   credential_header="["$2"]"

   x=$(cat $1 |sed 's/=/ = /g' | awk 'BEGIN{

      marker=0; exist=0; ch=0 }
      {
        if ($1 == CRED) {
           exist=1
           marker=1
        }
        else
           if (substr($1,0,1) == "[")
              marker=0

        if (marker == 1) {

           if ($1 == "aws_access_key_id")
              if ($2 == KEY)
                 ++ch

           if ($1 == "aws_secret_access_key")
              if ($2 == SECRET)
                 ++ch
        }
      }END{
         if (!exist)
            print ("0");
         else
            if (ch!=2)
               printf("2")
            else
               print("1")

      }' CRED=${credential_header} KEY=$3 SECRET=$4)

   return $x
}

function check_aws_connectivity() {
   echo -n "Checking AWS credentials connectivity                            .. "

   account_owner=$(aws ${AWS_ARGS} sts get-caller-identity --query "Account" --output text)

   if [ $? -eq 0 ]; then
      echo "account number ${account_owner}"
      return 0
   else
      red_echo "failed. Please check AWS credentials"
      return 1
   fi
}

function check_env_variables() {

   if [ "$(cloud_provider_installed aws)" == "yes" ]; then
      if [ -z "${AWS_PROFILE}" ]; then
         red_echo "$0: Warning AWS_PROFILE environment variable not set, exiting."
         exit 1
      fi

      if [ -z "${AWS_REGION}" ]; then
         red_echo "$0: Warning AWS_REGION environment variable not set, exiting."
         exit 1
      fi 
   fi

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then
      if [ -z "${ARM_SUBSCRIPTION_ID}" ]; then
         red_echo "$0: Warning ARM_SUBSCRIPTION_ID environment variable not set, exiting."
         exit 1
      fi

      if [ -z "${ARM_TENANT_ID}" ]; then
         red_echo "$0: Warning ARM_TENANT_ID environment variable not set, exiting."
         exit 1
      fi
   fi
}

function get_account_owner() {
   provider=$1

   if [ "${provider}" == "aws" ]; then
      aws ${AWS_ARGS} sts get-caller-identity \
          --query "Account" \
          --output text
   
      if [ $? -ne 0 ]; then       
         red_echo "Warning, cannot determine AWS Account number, check AWS credentials and access, exiting."
         exit 1
      fi    
   fi

   if [ "${provider}" == "azure" ]; then
      jq -n "${TFVARS_JSON}" | \
         jq -r '.account_owner["azure"]["'${environment_name}'"]'
   fi
}

function check_region() {
   alt_region=$1

   if [ "${cloud_provider}" == "azure" ]; then

      if [ -n "$(az account list-locations | \
              jq -r '.[].name == "'${alt_region}'"' | \
                 grep true)" ]; then
         return 0
      else
         return 1
      fi
   fi

   if [ "${cloud_provider}" == "aws" ]; then

      aws ${AWS_ARGS} ec2 describe-regions \
          --region-names=${alt_region} > /dev/null 2>&1

      return $?
   fi
}

function get_aws_profile_value() {
   cred=$1
   key=$2

   get_credential "${cred}" "${key}"
}

function verify_credentials() {

   key=$(get_credential "${AWS_PROFILE}" aws_access_key_id)
   secret=$(get_credential "${AWS_PROFILE}" aws_secret_access_key)

   if [ "${key}" == "" ]; then
      red_echo "$0: Warning, cannot derive user credential [aws_access_key_id], exiting."
      exit 1
   fi

   if [ "${secret}" == "" ]; then
      red_echo "$0: Warning, cannot derive user credential [aws_secret_access_key], exiting."
      exit 1
   fi

   for cred in ${AWS_PROFILE} ${remote_state}
   do
      check_credential_entry ${AWS_CRED} ${cred} ${key} ${secret}
      estat=$?

      if [ ${estat} -eq 0 ]; then
         echo
         exit_on_no "Add \"[${cred}]\" entry in ${AWS_CRED}?" 0
         echo
         printf "Adding AWS credentials for %-37s .. " ${cred}
         replace_credential ${AWS_CRED} "${cred}" "${key}" "${secret}"
   
         if [ $? -ne 0 ]; then
            red_echo failed 
            exit_prog 1
         else
            echo done
         fi
      fi

      if [ ${estat} -eq 1 ]; then
         exit_on_no "Replace \"[${cred}]\" entry in ${AWS_CRED}?" 0

         printf "Updating AWS credentials for %-35s .. " ${cred}
         replace_credential ${AWS_CRED} "${cred}" "${key}" "${secret}"

         if [ $? -ne 0 ]; then
            red_echo failed
            exit_prog 1
         else
            echo done
         fi
      fi
   done
}

function prepare_state_setup() {

   echo "Initialising ${TF_PROG} configuration .. "

   AZURE_ACCOUNT_OWNER=$(jq -n "${TFVARS_JSON}" | \
                         jq -r '.account_owner["azure"]["'${environment_name}'"]')

   if [ "$(cloud_provider_installed aws)" == "yes" ]; then

      echo
      echo "Preparing AWS initialisation"
      primary_region=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["aws"][0].region_name')

      printf " - %-60s" "packer IAM role "
   
      aws ${AWS_ARGS} iam create-role \
          --role-name packer \
          --assume-role-policy-document \
            '{
              "Version": "2012-10-17",
              "Statement": {
                "Effect": "Allow",
                "Principal": {"Service": "ec2.amazonaws.com"},
                "Action": "sts:AssumeRole"
              }
            }' > /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed."
         red_echo "Warning, failed to create packer IAM role, exiting."
         exit 1
      else
         echo "ok."
      fi
   
      printf " - %-60s" "packer IAM policy "
   
   
      aws ${AWS_ARGS} iam create-policy \
          --policy-name packer \
          --policy-document \
            '{
             "Version": "2012-10-17",
             "Statement": [
                 {
                     "Effect": "Allow",
                     "Action": [
                         "s3:GetObject"
                     ],
                     "Resource": [
                         "arn:aws:s3:::dotnext-software",
                         "arn:aws:s3:::dotnext-software/*"
                     ]
                 }
             ]
         }' > /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed."
         red_echo "Warning, failed to create packer IAM policy, exiting."
         exit 1
      else
         echo "ok."
      fi
   
      printf " - %-60s" "packer IAM instance profile "
   
      aws ${AWS_ARGS} iam create-instance-profile \
          --instance-profile packer > /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed."
         red_echo "Warning, failed to create packer IAM instance profile, exiting."
         exit 1
      else
         echo "ok."
      fi
   
      printf " - %-60s" "packer IAM add policy to role "
   
      aws ${AWS_ARGS} iam add-role-to-instance-profile \
          --instance-profile-name packer \
          --role-name packer> /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed."
         red_echo "Warning, failed to add packer role IAM instance profile, exiting."
         exit 1
      else
         echo "ok."
      fi
   
      if [ "${tf_state_cloud_provider}" == "aws" ]; then
   
         printf " - %-60s" "S3 state bucket "
   
         if [ "${primary_region}" == "us-east-1" ]; then
            S3_CREATION_CMD="aws ${AWS_ARGS} s3api create-bucket \
                                 --bucket "${state_storage}" \
                                 --region "${primary_region}
         else
            S3_CREATION_CMD="aws s3api create-bucket \
                                 --bucket "${state_storage}" \
                                 --region "${primary_region}" \
                                 --create-bucket-configuration LocationConstraint="${primary_region}
         fi
   
         output_msg=$(${S3_CREATION_CMD} 2>&1)
         if [ $? -ne 0 ]; then
            echo " failed."
            echo
            red_echo "Warning, failed to create S3 bucket ${state_storage}, exiting."
            echo
            echo "  Command \"${S3_CREATION_CMD}\""
            echo
            echo "  Returned:"
            echo "${output_msg}" | awk '{if(length($0)) printf("    --> %s\n",$0)}'
            echo
            exit 1
         fi
   
         aws ${AWS_ARGS} s3api put-bucket-encryption \
             --bucket ${state_storage} \
             --region ${primary_region} \
             --server-side-encryption-configuration '{"Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]}' > /dev/null 2>&1
   
         if [ $? -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to enable server side encruption to  S3 bucket ${state_storage}, exiting."
   
            aws ${AWS_ARGS} s3api delete-bucket \
                --bucket ${state_storage} \
                --region ${primary_region} > /dev/null 2>&1
   
            exit 1
         fi
   
         aws ${AWS_ARGS} s3api put-bucket-versioning \
             --bucket ${state_storage} \
             --versioning-configuration Status=Enabled \
             --region ${primary_region} > /dev/null 2>&1
   
         if [ $? -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to add versioning to S3 bucket ${state_storage}, exiting."
   
            aws ${AWS_ARGS} s3api delete-bucket \
                --bucket ${state_storage} \
                --region ${primary_region} > /dev/null 2>&1
   
            exit 1
         fi
   
         aws ${AWS_ARGS} s3api put-public-access-block \
             --bucket ${state_storage} \
             --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
   
         if [ $? -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to put public access blocking on S3 bucket ${state_storage}, exiting."
   
            aws ${AWS_ARGS} s3api delete-bucket \
                --bucket ${state_storage} > /dev/null 2>&1
   
            exit 1
         fi
   
         echo "ok."
         printf " - %-60s" "dynamodb lock table "
   
         aws ${AWS_ARGS} dynamodb create-table \
             --table-name ${lockfile} \
             --attribute-definitions AttributeName=LockID,AttributeType=S \
             --provisioned-throughput ReadCapacityUnits=20,WriteCapacityUnits=20 \
             --key-schema AttributeName=LockID,KeyType=HASH > /dev/null 2>&1
   
         if [ $? -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to create dynamodb lock table ${lockfile}, exiting."
   
            aws ${AWS_ARGS} s3api delete-bucket \
                --bucket ${state_storage} > /dev/null 2>&1
   
            exit 1
         else
            echo "ok."
         fi
      fi
   fi

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then
      echo
      echo "Preparing Azure initialisation"
      primary_region=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["azure"][0].region_name')
      printf " - %-60s" "creating packer RBAC \"Key Vault Administrator\" role "

      az ad sp create-for-rbac \
           --role "Key Vault Administrator" \
           --display-name "${environment_name}-packer-server-role" \
           --scopes /subscriptions/${AZURE_ACCOUNT_OWNER} > /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed"
         red_echo "Warning, failed to create rbac \"Key Vault Administrator\" role for \"${AZURE_ACCOUNT_OWNER}\", exiting."
         exit 1
      else
         echo "ok."
      fi
   
      printf " - %-60s" "creating packer RBAC \"Key Vault Certificates Officer\" role "
   
      az ad sp create-for-rbac \
           --role "Key Vault Certificates Officer" \
           --display-name "${environment_name}-packer-server-role" \
           --scopes /subscriptions/${AZURE_ACCOUNT_OWNER} > /dev/null 2>&1
   
      if [ $? -ne 0 ]; then
         echo " failed"
         red_echo "Warning, failed to create rbac \"Key Vault Certificates Officer\" role for \"${AZURE_ACCOUNT_OWNER}\", exiting."
         exit 1
      else
         echo "ok."
      fi
   
      printf " - %-60s" "creating packer RBAC \"Owner\" role "
   
      rbac_secrets=$(az ad sp create-for-rbac \
                      --role Owner \
                      --display-name "${environment_name}-packer-server-role" \
                      --scopes /subscriptions/${AZURE_ACCOUNT_OWNER} \
                      --query "{ client_id: appId, client_secret: password, tenant_id: tenant }"  2> /dev/null)
   
      if [ $? -ne 0 ]; then
         echo " failed"
         red_echo "Warning, failed to create rbac \"Owner\" role for \"${AZURE_ACCOUNT_OWNER}\", exiting."
         exit 1
      else
         echo "ok."
      fi
   
      ARM_CLIENT_ID=$(jq -n "${rbac_secrets}" | \
                      jq -r '.client_id')
      ARM_CLIENT_SECRET=$(jq -n "${rbac_secrets}" | \
                          jq -r '.client_secret')
   
      if [ "${tf_state_cloud_provider}" == "azure" ]; then
         grp_check=$(az group list | \
            jq -r '.[] | select(.name | match("AIL-resource-group")) | .name')
   
         if [ "${grp_check}" != "${RESOURCE_GROUP}" ]; then
            printf " - %-60s" "creating az group \"${RESOURCE_GROUP_NAME}\" "
   
            az group create --name ${RESOURCE_GROUP_NAME} \
               --location ${primary_region} > /dev/null 2>&1
            retVal=$?
   
            if [ ${retVal} -ne 0 ]; then
               echo " failed."
               red_echo "Warning, failed to create \"${RESOURCE_GROUP_NAME}\" az group, exiting."
               exit 1
            else
               echo "ok."
            fi
         fi
      
         printf " - %-60s" "creating az storage account \"${STORAGE_ACCOUNT_NAME}\" "
         az storage account create --resource-group ${RESOURCE_GROUP_NAME} \
             --name ${STORAGE_ACCOUNT_NAME} \
             --sku Standard_LRS \
             --encryption-services blob > /dev/null 2>&1
         retVal=$?
         if [ ${retVal} -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to create \"${STORAGE_ACCOUNT_NAME}\" az storage group, exiting."
            exit 1
         else
            echo "ok."
         fi
      
         sleep 10
         printf " - %-60s" "creating az blob container \"${state_storage}\" "
         az storage container create \
            --name ${state_storage} \
            --account-name ${STORAGE_ACCOUNT_NAME} > /dev/null 2>&1
         retVal=$?
      
         if [ ${retVal} -ne 0 ]; then
            echo " failed."
            red_echo "Warning, failed to create az blob container \"${state_storage}\" , exiting."
            exit 1
         else
            echo "ok."
         fi
   
         ACCOUNT_KEY=$(az storage account keys list \
                       --resource-group ${RESOURCE_GROUP_NAME} \
                       --account-name ${STORAGE_ACCOUNT_NAME} \
                       --query '[0].value' -o tsv)
   
         ARM_ACCOUNT_KEY=${ACCOUNT_KEY}
   
         echo "ARM_ACCOUNT_KEY=\"${ARM_ACCOUNT_KEY}\"" > ${TLD}/.secrets
         echo "ARM_CLIENT_ID=\"${ARM_CLIENT_ID}\"" >> ${TLD}/.secrets
         echo "ARM_CLIENT_SECRET=\"${ARM_CLIENT_SECRET}\"" >> ${TLD}/.secrets
   
         echo
      fi
   fi
}

function remove_state_setup() {

   if [ "$(jq -n "${TFVARS_JSON}" | \
           jq -r '.account_owner')" != "null" ]; then
      AWS_ACCOUNT_OWNER=$(jq -n "${TFVARS_JSON}" | \
                          jq -r '.account_owner["aws"]["'${environment_name}'"]')

      AZURE_ACCOUNT_OWNER=$(jq -n "${TFVARS_JSON}" | \
                            jq -r '.account_owner["azure"]["'${environment_name}'"]')
   else
      AWS_ACCOUNT_OWNER=$(cat "${TFVAR_DIR}/${TFVAR_GEN}" | hcl2json | \
                          jq -r '.account_owner["aws"]["'${environment_name}'"]')

      AZURE_ACCOUNT_OWNER=$(cat "${TFVAR_DIR}/${TFVAR_GEN}" | hcl2json | \
                            jq -r '.account_owner["azure"]["'${environment_name}'"]')
   fi

   if [ "$(cloud_provider_installed aws)" == "yes" ]; then
      echo
      echo "Removing AWS state configuration"

      if [ "${tf_state_cloud_provider}" == "aws" ]; then
         check_aws_connectivity > /dev/null
   
         if [ -n "${state_storage}" ]; then
            printf " - %-68s" "DynamoDB table "
      
            aws ${AWS_ARGS} dynamodb delete-table \
                --table-name ${lockfile} > /dev/null 2>&1
   
            if [ $? -ne 0 ]; then
               echo "failed."
               red_echo "Failed to delete dynamodb table"
            else
               echo "ok."
            fi
         fi
      fi
   
      printf " - %-68s" "packer IAM "
      aws ${AWS_ARGS} iam remove-role-from-instance-profile \
          --instance-profile-name packer \
          --role-name packer > /dev/null 2>&1

      if [ $? -ne 0 ]; then
         echo "failed."
         red_echo "Failed to delete packer role-from-instance-profile"
      else
         echo "ok."
      fi
      
      printf " - %-68s" "packer policy "

      aws ${AWS_ARGS} iam delete-policy \
          --policy-arn arn:aws:iam::${AWS_ACCOUNT_OWNER}:policy/packer > /dev/null 2>&1

      if [ $? -ne 0 ]; then
         echo "failed."
         red_echo "Failed to delete packer policy"
      else
         echo "ok."
      fi
      
      printf " - %-68s" "packer instance-profile "

      aws ${AWS_ARGS} iam delete-instance-profile \
          --instance-profile-name packer > /dev/null 2>&1

      if [ $? -ne 0 ]; then
         echo "failed."
         red_echo "Failed to delete packer instance-profile"
      else
         echo "ok."
      fi
      
      printf " - %-68s" "packer role "

      aws ${AWS_ARGS} iam delete-role \
          --role-name packer > /dev/null 2>&1
      
      if [ $? -ne 0 ]; then
         echo "failed."
         red_echo "Failed to delete packer role"
      else
         echo "ok."
      fi
      
      if [ "${tf_state_cloud_provider}" == "aws" ]; then
      
         for bucket in ${state_storage}
         do
            printf " - %-68s" "S3 bucket \"${bucket}\" "

            obj_list=$(aws ${AWS_ARGS} s3api list-object-versions \
                           --bucket ${bucket} \
                           --output=json \
                           --query='{Objects: Versions[].{Key:Key,VersionId:VersionId}}' 2> /dev/null)

            if [ $? -ne 0 ]; then
               echo "failed."
               red_echo "Failed to list-object-versions on bucket"
            else
               echo "ok."
            fi

            if [ -n "${obj_list}" ]; then
               printf "   - %-66s" "found content in bucket, attempting to empty "
               writelog "Attempting to empty bucket \"${bucket}\""
               logorno 'aws ${AWS_ARGS} s3api delete-objects --bucket ${bucket} --delete "${obj_list}" > /dev/null 2>&1'
            fi
   
            logorno 'aws ${AWS_ARGS} s3api delete-bucket --bucket ${bucket} > /dev/null 2>&1'
            echo -n "ok."
         done
         echo
      fi

      echo
      exit_on_no "Remove ssm parameters?" 0
   
      printf " - %-68s" "Removing ssm parameters "
   
      for alt_region in $(get_regions "aws" all)
      do
         params_to_search="grep "$(for match in \
                      replication_leader \
                      last_admin_server \
                      last_runtime_server \
                      deployment_status \
                      pingfed_admin_jwk \
                      pingfed_admin_password \
                      pingfed_backup_password \
                      pingfed_cluster_password
         do
            echo -n "-e ${match} "

         done)

         for param in $(aws ssm describe-parameters \
                        --region ${alt_region} 2> /dev/null | \
                        jq -r '.Parameters[].Name' | ${params_to_search} )
         do
            aws ${AWS_ARGS} ssm delete-parameter \
                  --name ${param} \
                  --region ${alt_region} > /dev/null 2>&1
              echo -n "."
         done
      done
      echo "ok."
   fi

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then
      echo
      echo "Removing Azure state configuration"

      for name in "${environment_name}-packer-server-role"
      do
         printf " - %-68s" "role assignment ${name} "

         object_id=$(az ad sp list --all | \
                     jq -r '.[] | select(IN(.displayName; "'${name}'")) | .id' 2> /dev/null)
   
         if [ -n "${object_id}" ]; then

            az role assignment delete \
               --assignee ${object_id} > /dev/null 2>&1
      
            if [ $? -eq 0 ]; then
               echo "ok."
            else
               echo "failed."
               red_echo "Failed to delete role assignment \"${name}\""
            fi
         else
            echo "- no objects found"
         fi
      done

      if [ "${tf_state_cloud_provider}" == "azure" ]; then

         ARM_ACCOUNT_KEY=$(az storage account keys list \
                          --resource-group ${RESOURCE_GROUP_NAME} \
                          --account-name ${STORAGE_ACCOUNT_NAME} \
                          --query '[0].value' -o tsv)
   
   
         printf " - %-60s" "az storage container "
   
         az storage container delete \
            --account-key "${ARM_ACCOUNT_KEY}" \
            --account-name ${STORAGE_ACCOUNT_NAME} \
            --name ${state_storage} > /dev/null 2>&1
   
         retVal=$?
   
         if [ ${retVal} -ne 0 ]; then
            echo "failed."
            red_echo "Failed with exit code ${retVal}"
         else
            echo "ok."
         fi
   
         printf " - %-60s" "az storage account "
   
         az storage account delete \
            --name ${STORAGE_ACCOUNT_NAME} \
            --yes > /dev/null 2>&1
   
         retVal=$?
   
         if [ ${retVal} -ne 0 ]; then
            echo "failed."
            red_echo "Failed with exit code ${retVal}"
         else
            echo "ok."
         fi
   
         printf " - %-60s" "az group "
   
         az group delete --name ${RESOURCE_GROUP_NAME} \
            --yes > /dev/null 2>&1
   
         retVal=$?
   
         if [ ${retVal} -ne 0 ]; then
            echo "failed."
            red_echo "Failed with exit code ${retVal}"
         else
            echo "ok."
         fi
      fi
   fi
}

function deregister_ami() {

   ami_region=$1
   curr_ami_id=$2

   if [ "${cloud_provider}" == "aws" ]; then
      logorno "aws ec2 deregister-image \
                   --region ${ami_region} \
                   --image-id ${curr_ami_id}"
      retVal=$?
   fi

   if [ "${cloud_provider}" == "azure" ]; then
      echo "RUNNING: az image delete \
         --resource-group AIL-resource-group \
         --name ${curr_ami_id}" >> /tmp/qq

      logorno "az image delete \
         --resource-group AIL-resource-group \
         --name ${curr_ami_id}"
      retVal=$?
   fi

   if [ ${retVal} -eq 0 ]; then
       echo "done"
    else
       red_echo "failed"
    fi
}

function set_deployment_status() {

   status=$1


   if [ "$(cloud_provider_installed aws)" == "yes" ]; then

      for alt_region in $(get_regions "aws" all)
      do
         echo "Setting deployment_status in ${alt_region} to ${status}"
         aws ssm put-parameter \
             --region ${alt_region} \
             --profile "${customer_name}_${environment_name}" \
             --type "String" \
             --overwrite --name "/${customer_name}/${environment_name}/deployment_status" \
             --value ${status} > /dev/null 2>&1
   
         if [ $? -ne 0 ]; then
            red_echo "Warning failed to update \"deployment_status\" ssm parameter"
         fi
      done
   fi

   if [ "$(cloud_provider_installed azure)" == "yes" ]; then

      for alt_region in $(get_regions "azure" all)
      do
         echo "Setting deployment_status in ${alt_region} to ${status}"
         az keyvault secret set \
            --vault-name "${alt_region}-${customer_name}-${environment_name}" \
            --name "${customer_name}-${environment_name}-deployment-status" \
            --value ${status} > /dev/null 2>&1
   
         if [ $? -ne 0 ]; then
            red_echo "Warning failed to update \"deployment-status\" keyvault at ${alt_region}"
         fi
      done
   fi
}

function get_amis() {

   account_owner=$(get_account_owner ${cloud_provider})

   if [ "${cloud_provider}" == "aws" ]; then
      aws ${AWS_ARGS} ec2 describe-images \
          --region ${ami_region} \
          --owners ${account_owner} \
          --query "Images[*].[ImageId,Name]" \
          --output text |sed 's/\t/:/'
   fi

   if [ "${tf_state_cloud_provider}" == "azure" ]; then
      az image list \
          --resource-group AIL-resource-group \
          --region ${ami_region} \
          --owners ${account_owner} \
          --query "Images[*].[ImageId,Name]" \
          --output text |sed 's/\t/:/'
   fi
}

function add_region_provider() {

   cloud_provider=$1
   region_alias=$2
   region_name=$3

   subscription_id=$(get_account_owner "azure")

   if [ "${cloud_provider}" == "aws" ]; then
      echo 'provider "aws" {
   profile = join("_", [var.customer_name, terraform.workspace])
   alias   = "'${region_alias}'"
   region  = "'${region_name}'"

   default_tags {
      tags = {
         Customer    = var.customer_name
         Environment = terraform.workspace
      }
   }
}
'
   fi

   if [ "${cloud_provider}" == "azure" ]; then
         echo 'provider "azurerm" {
   subscription_id = "'${subscription_id}'"
   alias           = "'${region_alias}'" 
   features {} 
}     
'  
   fi
}

function add_other_providers() {

   cloud_provider=$1

   if [ "${cloud_provider}" == "aws" ]; then

      echo 'provider "aws" {
  alias   = "route53"
  region  = "'${primary_aws_region}'"
  profile = '${ROUTE53_PROVIDER}'
}

provider "aws" {
  alias   = "remote_state"
  region  = "'${primary_aws_region}'"
  profile = var.remote_state
}
'
   fi
}

function empty_storage() {

   product=$1
   region_alias=$2

   dns_suffix=$(jq -n "${TFVARS_JSON}" | \
                jq -r '.dns_suffix["'${CLOUD_PLATFORM}'"]')

   bucket_prefix=$(jq -n "${TFVARS_JSON}" | \
                   jq -r '.products["'${product}'"].parameters.backup_prefix')

   if [ -z "${bucket_prefix}" -o "${bucket_prefix}" == "null" ]; then
      return
   fi

   bucket="${bucket_prefix}.${region_alias}.${environment_name}.${customer_name}.${dns_suffix}"
   chk=$(aws ${AWS_ARGS} s3api list-objects --bucket ${bucket} 2> /dev/null )
   backup_entries=$(echo ${chk} | grep Key | wc -l | awk '{print $1}')

   if [ ${backup_entries} -gt 0 ]; then

      echo "S3 bucket \"${bucket}\" has content, emptying"
  
      aws ${AWS_ARGS} s3api delete-objects --bucket ${bucket} \
            --delete "$(aws ${AWS_ARGS} s3api list-object-versions \
            --bucket ${bucket} --output=json \
            --query='{Objects: Versions[].{Key:Key,VersionId:VersionId}}')" > /dev/null 2>&1
   fi
}

function create_locals() {

    printf "\nlocals {\n\n"

   echo '   san_list = distinct([for c, d in compact(flatten([for a,b in var.manifest["'${CLOUD_PLATFORM}'"] : [for index,entry in var.products : var.manifest["'${CLOUD_PLATFORM}'"][a].products[index][terraform.workspace] > 0 ? split(",", try(entry.parameters["dns_prefix"], "")) : []]])) : trimspace(join(".", [d, terraform.workspace, var.customer_name, var.dns_suffix[var.cloud_provider]]))])' 

   cloud_providers_json=$(echo ${cloud_providers} | \
                          awk 'BEGIN{printf("\[")}{for (i=1; i<=NF; ++i) printf("\"%s\",", $i)
                          printf("\]\n")}' | \
                          sed 's/,\]/\]/')
   echo
   echo "   cloud_providers       = ${cloud_providers_json}"
   echo "   tenant_id             = \"${ARM_TENANT_ID}\""
   echo "   client_id             = \"${ARM_CLIENT_ID}\""
   echo "   client_secret         = \"${ARM_CLIENT_SECRET}\""
   echo


   printf "   cloud_peerings = {\n"

   for cloud_provider in ${cloud_providers}
   do
      number_regions=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["'${cloud_provider}'"] | keys' 2> /dev/null | \
                       wc -l | awk '{print $1-2}')
      echo "      ${cloud_provider} = {"

      for cloud_provider2 in ${cloud_providers}
      do
         label='"'${cloud_provider2}'"'
         if [ "${cloud_provider}" != "${cloud_provider2}" ] ;then
            printf '         %s = flatten([for x,y in var.manifest["'${cloud_provider2}'"] : compact(distinct([for c,d in y.products : d[terraform.workspace] > 0 ? y.region_alias : ""]))])\n' ${label}
         fi
      done

      for cloud_provider3 in "aws" "azure"
      do
         if [ "${cloud_provider3}" != "${cloud_provider}" ]; then
            if [ -z "$(echo ${cloud_providers} | grep ${cloud_provider3})" ]; then
               label='"'${cloud_provider3}'"'
               printf '         %s = []\n' ${label}
            fi
         fi
      done

      echo "      }"
   done

   printf "   }\n\n"

   web_ingress_installed=$(jq -n "${TFVARS_JSON}" | \
                           jq -r '.manifest["azure"] | .[].products["web_ingress"]["'${environment_name}'"]' | \
                           awk '{x+=$1}END{print x}')

   web_ingress_installed=$(jq -n "${TFVARS_JSON}" | \
                           jq -r '.manifest["azure"] | .[].products["web_ingress"]["'${environment_name}'"]' | \
                           awk '{x+=$1}END{print x}')

   if [ "${web_ingress_installed}" == "null" -o -z "${web_ingress_installed}" ]; then
      web_ingress_installed=0
   fi

   if [ ${web_ingress_installed} -gt 0 ]; then
      echo '   lb_addresses = {'

      for app in $(jq -n "${TFVARS_JSON}" | \
                   jq -r .'products | keys | .[]')
      do
         label='"'${app}'"'
         dns_prefix=$(jq -n "${TFVARS_JSON}" | \
                      jq -r '.products["'${app}'"].parameters.dns_prefix')

         if [ "${dns_prefix}" != "null" ]; then
            app_installed=$(jq -n "${TFVARS_JSON}" | \
                            jq -r '.manifest["azure"] | .[].products["'${app}'"]["'${environment_name}'"]' | \
                            awk '{x+=$1}END{print x}')

            printf "      %-24s = " ${label}
  
            if [ ${app_installed} -gt 0 ]; then
               app_list=""
               region_number=0

               while [ ${region_number} -lt ${number_regions} ]; do
                  region_alias=$(jq -n "${TFVARS_JSON}" | \
                                 jq -r '.manifest["azure"]['${region_number}'].region_alias')
                  installed_here=$(jq -n "${TFVARS_JSON}" | \
                                   jq -r '.manifest["azure"]['${region_number}'].products["'${app}'"]["'${environment_name}'"]' | \
                                   awk '{x+=$1}END{print x}')

                  if [ ${installed_here} -gt 0 ]; then
                     app_list="${app_list}, module.web_ingress_${region_alias}.web_ingress_lb_address"
                  fi
                  ((region_number+=1))
               done

               list=$(echo ${app_list} | \
                      sed 's/^, //g')
               echo "[${list}]"
            else
               echo "[]"
            fi
         fi
      done

      printf "   }\n\n"
   fi

   web_ingress_installed=$(jq -n "${TFVARS_JSON}" | \
                           jq -r '.manifest["aws"] | .[].products["web_ingress"]["'${environment_name}'"]' | \
                           awk '{x+=$1}END{print x}')

   number_regions=$(jq -n "${TFVARS_JSON}" | \
                    jq -r '.manifest["aws"] | keys' 2> /dev/null | wc -l | awk '{print $1-2}')

   if [ "${web_ingress_installed}" == "null" -o -z "${web_ingress_installed}" ]; then
      web_ingress_installed=0
   fi

   if [ ${web_ingress_installed} -gt 0 ]; then
      echo '   target_group_arns = {'

      for app in $(jq -n "${TFVARS_JSON}" | \
                   jq -r .'products | keys | .[]')
      do
         web_ingress=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.products["'${app}'"].parameters.web_ingress')
   
         if [ "${web_ingress}" == "true" ]; then
            dns_prefix=$(jq -n "${TFVARS_JSON}" | \
                         jq -r '.products["'${app}'"].parameters.dns_prefix')
            app_installed=$(jq -n "${TFVARS_JSON}" | \
                            jq -r '.manifest["aws"] | .[].products["'${app}'"]["'${environment_name}'"]' | \
                            awk '{x+=$1}END{print x}')

            if [ ${app_installed} -gt 0 ]; then
               echo "      \"${dns_prefix}\" = {"
               app_list=""
               region_number=0
      
               while [ ${region_number} -lt ${number_regions} ]; do
                  region_alias=$(jq -n "${TFVARS_JSON}" | \
                                 jq -r '.manifest["aws"]['${region_number}'].region_alias')
                  installed_here=$(jq -n "${TFVARS_JSON}" | \
                                   jq -r '.manifest["aws"]['${region_number}'].products["'${app}'"]["'${environment_name}'"]' | \
                                   awk '{x+=$1}END{print x}')
                  if [ ${installed_here} -gt 0 ]; then
                     label='"'${region_alias}'"'
                     module=$(jq -n "${TFVARS_JSON}" | \
                              jq -r '.products["'${app}'"].module')
                     printf "         %-12s = module.${app}_${region_alias}.${module}_target_group_arn\n" "${label}"
                  fi
                  ((region_number+=1))
               done
               echo '      }'
            fi
         fi
      done
   
      printf "   }\n\n"
   fi
   echo '   subnet_cidr_blocks = {'

   number_subnets=$(jq -n "${TFVARS_JSON}" | \
                    jq -r '.subnets | length')

   subnet_number=0

   all_regions=""
   for cloud_provider in ${cloud_providers}
   do
      all_regions="$(get_regions ${cloud_provider} all) ${all_regions}"
   done

   while [ ${subnet_number} -lt ${number_subnets} ]; do

      subnet_name=$(jq -n "${TFVARS_JSON}" | \
                    jq -r '.subnets['${subnet_number}'].subnet_name')
      label='"'${subnet_name}'"'

      string_list=""
      for alt_region in ${all_regions}
      do
         alt_alias=$(get_region_alias ${alt_region})
         string_list="${string_list}module.network_${alt_alias}.vpc_subnet_cidr_blocks[\"${subnet_name}\"],"
      done

      merge_list=$(echo "${string_list}" | sed 's/,$//')

      printf '      %-12s = concat(%s)\n' ${label} "${merge_list}"

      ((subnet_number+=1))
   done

   label='"'all'"'
   cidr_str=""
   for cloud_provider in ${cloud_providers}
   do
      cidr_str=${cidr_str}', [for index,val in var.manifest["'${cloud_provider}'"] : var.manifest["'${cloud_provider}'"][index].network_range[terraform.workspace]]'
   done

   printf '      %-12s = concat(%s)\n' "${label}" "$(echo ${cidr_str} | sed 's/^, //g')"

   printf "   }\n\n"

   echo '   products_installed = {'

   for cloud_provider in ${cloud_providers}
   do
      echo "      \"${cloud_provider}\" = {"

      for product in $(jq -n "${TFVARS_JSON}" | \
                       jq -r .'products | keys | .[]')
      do
         product_label='"'${product}'"'
         printf '         %-12s = {\n' ${product_label}

         region_number=0

         for alt_region in $(get_regions ${cloud_provider} all)
         do
            alt_alias=$(get_region_alias ${alt_region})
            label='"'${alt_alias}'"'
            number_servers=0
   
            if [ "$(jq -n "${TFVARS_JSON}" | \
                    jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]')" != "null" ]; then
               number_servers=$(jq -n "${TFVARS_JSON}" | \
                                jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]')
            fi
   
            if [ ${number_servers} -ne 0 ]; then
               printf '            %-12s = true\n' ${label}
            else
               printf '            %-12s = false\n' ${label}
            fi
            ((region_number+=1))
         done
         echo "         }"
      done
      echo "      }"
   done

   printf "   }\n\n"

   echo '   vpcs = {'

   for cloud_provider in ${cloud_providers}
   do
      for alt_region in $(get_regions ${cloud_provider} all)
      do
         alt_alias=$(get_region_alias ${alt_region})
         label='"'${alt_alias}'"'
   
         printf '      %-12s = module.network_%s.vpc_id\n' ${label} ${alt_alias}
      done
   done

   printf "   }\n\n"

   printf "   cloud_dns = {\n"

   for cloud_provider in ${cloud_providers}
   do
      echo
      echo "      \"${cloud_provider}\" = {"
      primary_alias=$(get_region_alias $(get_regions "${cloud_provider}" primary))
      echo "         \"internal\" = {"
      printf '            dns_zone_id   = module.network_%s.internal_dns_zone_id\n' ${primary_alias}
      printf '            dns_zone_name = module.network_%s.internal_dns_zone_name\n' ${primary_alias}
      echo "         }"

      echo "         \"external\" = {"
      printf '            dns_zone_id   = module.network_%s.external_dns_zone_id\n' ${primary_alias}
      printf '            dns_zone_name = module.network_%s.external_dns_zone_name\n' ${primary_alias}
      echo "         }"
      printf "      }\n"
   done

   printf "   }\n\n"

   echo "   security_group_ids = {"

   for cloud_provider in ${cloud_providers}
   do
      region_number=0

      number_regions=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["'${cloud_provider}'"] | keys' | \
                       wc -l | awk '{print $1-2}')

      while [ ${region_number} -lt ${number_regions} ]; do
         region_alias=$(jq -n "${TFVARS_JSON}" | \
                        jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_alias')
         label='"'${region_alias}'"'
         printf '\n      %-12s = {\n' ${label}
         product_number=0
   
         for product in $(jq -n "${TFVARS_JSON}" | \
                          jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products | keys | .[]')
         do
            module=$(jq -n "${TFVARS_JSON}" | \
                     jq -r '.products["'${product}'"].module')
            product_label='"'${module}'"'
   
            product_listed=$(jq -n "${TFVARS_JSON}" | \
                             jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]')
            if [ "${product_listed}" != "null" ]; then
               number_products=$(jq -n "${TFVARS_JSON}" | \
                                 jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].products["'${product}'"]["'${environment_name}'"]')
            else
               number_products=0
            fi
   
            if [ ${number_products} -gt 0 ]; then
               printf '         %-21s = module.network_%s.security_group_ids["%s"]\n' ${product} ${region_alias} ${module}
            else
               printf '         %-21s = ""\n' ${product}
            fi
   
            ((product_number+=1))
         done
   
         echo '      }'
   
         ((region_number+=1))
      done
   done

   printf "   }\n\n"

   if [ "$(cloud_provider_installed aws)" == "yes" ]; then
      echo '   peer_accepts = {'
      number_regions=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["aws"] | keys' 2> /dev/null | \
                       wc -l | awk '{print $1-2}')

      region_number=0
      while [ ${region_number} -lt ${number_regions} ]; do
         region_alias=$(jq -n "${TFVARS_JSON}" | \
                        jq -r '.manifest["aws"]['${region_number}'].region_alias')
         label='"'${region_alias}'"'
      if [ ${number_regions} -gt 1 ]; then
         printf '      %-24s = module.network_%s.peer_accept_id\n' ${label} ${region_alias}
      else
         printf '      %-24s = {}\n' ${label}
      fi
         ((region_number+=1))
      done
   
      echo '   }

   peer_connects = {'

      region_number=0
      while [ ${region_number} -lt ${number_regions} ]; do
         region_alias=$(jq -n "${TFVARS_JSON}" | \
                        jq -r '.manifest["aws"]['${region_number}'].region_alias')
         label='"'${region_alias}'"'
   
         if [ ${number_regions} -gt 1 ]; then
            printf '      %-24s = module.network_%s.peer_connect_id\n' ${label} ${region_alias}
         else
            printf '      %-24s = {}\n' ${label}
         fi
   
         ((region_number+=1))
      done

      printf "   }\n\n"
   fi

   if [ "$(cloud_provider_installed aws)" == "yes" -a "$(cloud_provider_installed azure)" == "yes" ]; then

      for cloud_provider in ${cloud_providers}
      do
         printf "   ${cloud_provider}_vpn_connections = {\n"
         number_regions=$(jq -n "${TFVARS_JSON}" | \
                          jq -r '.manifest["'${cloud_provider}'"] | keys' 2> /dev/null | \
                          wc -l | awk '{print $1-2}')

         region_number=0

         while [ ${region_number} -lt ${number_regions} ]
         do
            region_alias=$(jq -n "${TFVARS_JSON}" | \
                           jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_alias')
            label='"'${region_alias}'"'
            printf "\n      %s = {\n" ${label}
   
            if [ "${cloud_provider}" == "aws" ]; then
               echo "         aws_vpn_connection_aws2azure_1   = module.network_${region_alias}.aws_vpn_connection_aws2azure_1"
               echo "         aws_vpn_connection_aws2azure_2   = module.network_${region_alias}.aws_vpn_connection_aws2azure_2"
            fi

            if [ "${cloud_provider}" == "azure" ]; then
               echo "         azurerm_public_ip_azure2aws_1    = module.network_${region_alias}.azurerm_public_ip_azure2aws_1"
               echo "         azurerm_public_ip_azure2aws_2    = module.network_${region_alias}.azurerm_public_ip_azure2aws_2"
            fi
            echo "      }"
   
            ((region_number+=1))
         done
         printf "   }\n\n"
      done
   else
      for cloud_provider in "aws" "azure"
      do
         printf "   ${cloud_provider}_vpn_connections = {}\n"
      done
   fi

   printf "   subnet_ids = {\n"

   for cloud_provider in ${cloud_providers}
   do
      number_regions=$(jq -n "${TFVARS_JSON}" | \
                       jq -r '.manifest["'${cloud_provider}'"] | keys' | \
                       wc -l | awk '{print $1-2}')
      region_number=0

      while [ ${region_number} -lt ${number_regions} ]; do
         subnet_number=0
         region_alias=$(jq -n "${TFVARS_JSON}" | \
                        jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].region_alias')
         azs=$(jq -n "${TFVARS_JSON}" | \
               jq -r '.manifest["'${cloud_provider}'"]['${region_number}'].azs')

         label='"'${region_alias}'"'
         printf '      %-24s = module.network_%s.vpc_subnet_ids\n' ${label} ${region_alias}
         ((region_number+=1))
      done
   done

   printf "   }\n"

   printf "}\n"
}

function get_storage_backend() {

   if [ "${tf_state_cloud_provider}" == "aws" ]; then
      get_deployment_parameter terraform_backend_storage
   fi

   if [ "${tf_state_cloud_provider}" == "azure" ]; then
      get_deployment_parameter container_name
   fi

}

function get_installed_amis() {

   c_provider=$1
   account_owner=$(get_account_owner ${c_provider})

   if [ "${c_provider}" == "azure" ]; then
      az image list \
         --resource-group AIL-resource-group 2> /dev/null | \
         jq -r '.[] | select(.location | match("'${ami_region}'")) | .name' | \
         awk '{printf(":%s:\n",$1)}'
   fi

   if [ "${c_provider}" == "aws" ]; then
      aws ec2 describe-images --region ${ami_region} \
            --owners ${account_owner} \
            --query "Images[*].[ImageId,Name,CreationDate]" \
            --output text | sed 's/\t/:/g'
   fi
}

function build_amis() {

   PRIMARY_REGION=${1}
   AMI_ACCOUNT_OWNER=$(echo ${TFVARS_JSON} | \
                       jq -r '.ami_account_owner["'${cloud_provider}'"]["'${environment_name}'"]')

   if [ ! -d ${PACKER_DIR} ]; then
      red_echo "$0: Warning cannot access ${PACKER_DIR}, exiting"
      return 1
   fi
 
   if [ "${cloud_provider}" == "aws" ]; then
      OTHER_REGIONS=${2}
      echo "Calling packer with the following inputs:"
      echo
      echo "  profile:         ${AWS_PROFILE}"
      echo "  ${cloud_provider} account:     ${AMI_ACCOUNT_OWNER}"
      echo "  customer:        ${customer_name}"
      echo "  environment:     ${environment_name}"
      dns_suffix=$(jq -n "${TFVARS_JSON}" | \
                   jq -r '.dns_suffix["'${cloud_provider}'"]')
      echo "  dns suffix:      ${dns_suffix}"
      echo "  subscription_id: ${ARM_SUBSCRIPTION_ID}"
      echo "  tenant_id:       ${ARM_TENANT_ID}"
      echo "  client_id:       ${ARM_CLIENT_ID}"
      echo "  client_secret:   ${ARM_CLIENT_SECRET}"
      echo "  os_base:         ${OS_BASE_AWS}"
      echo "  os_redhat_base:  ${OS_BASE_AWS_REDHAT}"
      echo "  primary region:  ${PRIMARY_REGION}"
      echo "  other regions:   ${OTHER_REGIONS}"
      echo "  AMI prefix:      \"${AMI_PREFIX}\""
      echo "  AWS Access Id    \"${aws_access_key_id}\""
      echo "  AWS Secret Key   \"${aws_secret_access_key}\""
      echo
   
      (cd ${PACKER_DIR}; packer build \
             -only "*.amazon-ebs.${AMI_PREFIX}-base" \
             -var "profile=${AWS_PROFILE}" \
             -var "aws_account=${AMI_ACCOUNT_OWNER}" \
             -var "region=${PRIMARY_REGION}" \
             -var "customer_name=${customer_name}" \
             -var "environment_name=${environment_name}" \
             -var "dns_suffix=${dns_suffix}" \
             -var "ami_prefix=${AMI_PREFIX}" \
             -var "ami_regions=${OTHER_REGIONS}" \
             -var "tag_version=${TAG_VERSION}" \
             -var "aws_secret_access_key=${aws_secret_access_key}" \
             -var "aws_access_key_id=${aws_access_key_id}" \
             -var "os_base=${OS_BASE_AWS}" \
             -var "os_redhat_base=${OS_BASE_AWS_REDHAT}" \
             -var "os_base_win=${OS_BASE_AWS_WINDOWS}" \
             -var "subscription_id=${ARM_SUBSCRIPTION_ID}" \
             -var "tenant_id=${ARM_TENANT_ID}" \
             -var "client_id=${ARM_CLIENT_ID}" \
             -var "client_secret=${ARM_CLIENT_SECRET}" \
             .
      )

      retVal=$?
   
      if [ ${retVal} -ne 0 ]; then
         echo "Failed to build *.amazon-ebs.${AMI_PREFIX}-arm-base, exited with ${retVal}"
         return ${retVal}
      fi
   
      (cd ${PACKER_DIR}; packer build \
             -except "*.amazon-ebs.${AMI_PREFIX}-base","*.azure-arm.*" \
             -var "profile=${AWS_PROFILE}" \
             -var "aws_account=${AMI_ACCOUNT_OWNER}" \
             -var "region=${PRIMARY_REGION}" \
             -var "customer_name=${customer_name}" \
             -var "environment_name=${environment_name}" \
             -var "dns_suffix=${dns_suffix}" \
             -var "ami_regions=${OTHER_REGIONS}" \
             -var "ami_prefix=${AMI_PREFIX}" \
             -var "tag_version=${TAG_VERSION}" \
             -var "aws_secret_access_key=${aws_secret_access_key}" \
             -var "aws_access_key_id=${aws_access_key_id}" \
             -var "os_base=${OS_BASE_AWS}" \
             -var "os_base_win=${OS_BASE_AWS_WINDOWS}" \
             -var "os_redhat_base=${OS_BASE_AWS_REDHAT}" \
             -var "subscription_id=${ARM_SUBSCRIPTION_ID}" \
             -var "tenant_id=${ARM_TENANT_ID}" \
             -var "client_id=${ARM_CLIENT_ID}" \
             -var "client_secret=${ARM_CLIENT_SECRET}" \
             .
      )
   
      retVal=$?
   
      if [ ${retVal} -ne 0 ]; then
         echo "Failed to build *.amazon-ebs.${AMI_PREFIX}-arm-base, exited with ${retVal}"
      fi
   
      return ${retVal}
   fi

   if [ "${cloud_provider}" == "azure" ]; then
      OTHER_REGIONS=$(echo ${2} | sed 's/\[//g' | sed 's/\]//g' | sed 's/"//g' | sed 's/,/ /g')

      for build_region in ${OTHER_REGIONS}
      do
         RESOURCE_GROUP="AIL-resource-group"
   
         grp_check=$(az group list | \
         jq -r '.[] | select(.name | match("AIL-resource-group")) | .name')

         if [ "${grp_check}" != "${RESOURCE_GROUP}" ]; then
            echo "Creating resource group ${RESOURCE_GROUP}"
            az group create \
               --name ${RESOURCE_GROUP} \
               --location ${build_region} > /dev/null 2>&1
   
            if [ $? -ne 0 ]; then
               red_echo "Warning, failed to create resource-group \"${RESOURCE_GROUP}\""
            fi
         fi

         echo "Calling packer with the following inputs:"
         echo "  customer:        ${customer_name}"
         echo "  environment:     ${environment_name}"
         dns_suffix=$(jq -n "${TFVARS_JSON}" | \
                      jq -r '.dns_suffix["'${cloud_provider}'"]')
         echo "  dns suffix:      ${dns_suffix}"
         echo "  subscription_id: ${ARM_SUBSCRIPTION_ID}"
         echo "  account_key:     ${ARM_ACCOUNT_KEY}"
         echo "  tenant_id:       ${ARM_TENANT_ID}"
         echo "  client_id:       ${ARM_CLIENT_ID}"
         echo "  client_secret:   ${ARM_CLIENT_SECRET}"
         echo "  os_base:         ${OS_BASE_AZURE}"
         echo "  location:        ${build_region}"
         echo "  resource_group:  ${RESOURCE_GROUP}"
         echo "  AMI prefix:      \"${AMI_PREFIX}\""
         echo "  AWS Access Id    \"${aws_access_key_id}\""
         echo "  AWS Secret Key   \"${aws_secret_access_key}\""
         echo
   
         (cd ${PACKER_DIR}; packer build \
                 -only "*.azure-arm.${AMI_PREFIX}-base" \
                 -force \
                 -var "resource_group=${RESOURCE_GROUP}" \
                 -var "customer_name=${customer_name}" \
                 -var "environment_name=${environment_name}" \
                 -var "dns_suffix=${dns_suffix}" \
                 -var "account_key=${ARM_ACCOUNT_KEY}" \
                 -var "location=${build_region}" \
                 -var "ami_prefix=${AMI_PREFIX}" \
                 -var "tag_version=${TAG_VERSION}" \
                 -var "aws_secret_access_key=${aws_secret_access_key}" \
                 -var "aws_access_key_id=${aws_access_key_id}" \
                 -var "os_base=${OS_BASE_AZURE}" \
                 -var "os_redhat_base=${OS_BASE_AWS_REDHAT}" \
                 -var "os_base_win=${OS_BASE_AZURE_WINDOWS}" \
                 -var "subscription_id=${ARM_SUBSCRIPTION_ID}" \
                 -var "tenant_id=${ARM_TENANT_ID}" \
                 -var "client_id=${ARM_CLIENT_ID}" \
                 -var "client_secret=${ARM_CLIENT_SECRET}" \
                 .
         )

         retVal=$?
   
         if [ ${retVal} -ne 0 ]; then
            echo "Failed to build *.azure-arm.${AMI_PREFIX}-arm-base, exited with ${retVal}"
            return ${retVal}
         fi
   
         (cd ${PACKER_DIR}; packer build \
                 -except "*.amazon-ebs.*","*.azure-arm.${AMI_PREFIX}-base" \
                 -force \
                 -var "customer_name=${customer_name}" \
                 -var "environment_name=${environment_name}" \
                 -var "dns_suffix=${dns_suffix}" \
                 -var "resource_group=${RESOURCE_GROUP}" \
                 -var "account_key=${ARM_ACCOUNT_KEY}" \
                 -var "location=${build_region}" \
                 -var "tag_version=${TAG_VERSION}" \
                 -var "aws_secret_access_key=${aws_secret_access_key}" \
                 -var "aws_access_key_id=${aws_access_key_id}" \
                 -var "os_base=${OS_BASE_AZURE}" \
                 -var "os_base_win=${OS_BASE_AZURE_WINDOWS}" \
                 -var "ami_prefix=${AMI_PREFIX}" \
                 -var "subscription_id=${ARM_SUBSCRIPTION_ID}" \
                 -var "tenant_id=${ARM_TENANT_ID}" \
                 -var "client_id=${ARM_CLIENT_ID}" \
                 -var "client_secret=${ARM_CLIENT_SECRET}" \
                 .
         )
   
         retVal=$?

         if [ ${retVal} -ne 0 ]; then
            echo "Failed to build *.azure-arm.${AMI_PREFIX}-arm-base, exited with ${retVal}"
         fi
   
      done
      return ${retVal}
   fi
}

function get_control_ip() {

   alt_region=$1
   alt_region_alias=$(get_region_alias ${alt_region})

   if [ "${cloud_provider}" == "aws" ]; then
      instance_id=$(grep control_${alt_region_alias}.aws_instance.control ${DEBUG} | \
                    grep "Creation complete" | awk -F= '{print $2}'| awk -F\] '{print $1}')

      aws ${AWS_ARGS} ec2 describe-instances \
          --region=${alt_region} \
          --filters "Name=instance-state-name,Values=running" "Name=instance-id,Values=${instance_id}" \
          --query "Reservations[*].Instances[*].[PublicIpAddress]" \
          --output text 2> /dev/null | awk '{print $0}'
   fi

   if [ "${cloud_provider}" == "azure" ]; then
      az network public-ip list | \
      jq -r '.[] | select(IN(.location;"'${alt_region}'")) | select(IN(.name;"'${alt_region_alias}'-control-public_ip")) | .ipAddress'
   fi

}
